<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../mostly-elements/mostly-common/mostly-operation.html">
<link rel="import" href="../../mostly-elements/behaviors/mostly-i18n-behavior.html">

<!--
`nuxeo-collection-move-down-action`
@group Playing UI
@element nuxeo-collection-move-down-action
-->
<dom-module id="nuxeo-collection-move-down-action">
  <template>

    <style is="custom-style">
      :host {
        display: inline-block;
      }

      ::content iron-icon:hover {
        fill: var(--nuxeo-link-hover-color);
      }
    </style>

    <mostly-operation path="collections" op="moveCollectionMember" id="moveDownOp"></mostly-operation>

    <template id="availability" is="dom-if" if="[[_isAvailable(members)]]">
      <paper-icon-button noink
        id="downButton"
        icon="icons:arrow-downward">
      </paper-icon-button>
      <paper-tooltip for="downButton">[[i18n('collections.moveDown')]]</paper-tooltip>
    </template>

  </template>

  <script>
    Polymer({
      is: 'nuxeo-collection-move-down-action',
      behaviors: [Mostly.I18nBehavior],
      properties: {
        members: {
          type: Object
        },
        allMembers: {
          type: Object
        },
        collection: {
          type: Object
        },
        _member1Idx: {
          type: Number
        },
        _member2Idx: {
          type: Number
        }
      },

      listeners: {
        'tap': 'moveDown'
      },

      moveDown: function() {
        if (this.members && this.members.length === 1 && this.allMembers) {
          var member2 = this.members[0].id;
          var i = 0;
          for (; i < this.allMembers.length; i++) {
            if (this.allMembers[i].id === member2) {
              if (i < this.allMembers.length - 1) {
                this._member2Idx = i;
                this._member1Idx = i + 1;
                var member1 = this.allMembers[this._member1Idx].id;
                this.$.moveDownOp.input = this.collection.id;
                this.$.moveDownOp.params = {
                  member1: member1,
                  member2: member2
                };
                this.$.moveDownOp.execute().then(() => {
                  this.allMembers[this._member2Idx] = this.allMembers.splice(this._member1Idx, 1,
                    this.allMembers[this._member2Idx])[0];
                  this.fire('refresh-display', {focusIndex: this._member1Idx});
                });
              }
              break;
            }
          }
        }
      },

      _isAvailable: function() {
        if (this.members && this.members.length === 1) {
          if (this.allMembers && this.allMembers.length <= 1) {
            return false;
          }
          if (this.allMembers[this.allMembers.length - 1].id === this.members[0].id) {
            return false;
          }
          return true;
        }
        return false;
      }

    });
  </script>
</dom-module>
